<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Citation Network Visualization</title>
    <style>
      body {
        overflow: hidden;
        margin: 0;
      }

      text {
        font-family: sans-serif;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script>
      // Load JSON dynamically from the GitHub Pages static file
      d3.json("graph.json").then(function(graph) {
          initializeGraph(graph);
      }).catch(error => console.log("Error loading graph data:", error));

      function initializeGraph(graph) {
          var w = window.innerWidth;
          var h = window.innerHeight;

          var focusNode = null;
          var highlightNode = null;

          var textCenter = false;
          var outline = false;

          var minScore = Math.min(...graph.nodes.map(n => n.modularity));
          var maxScore = Math.max(...graph.nodes.map(n => n.modularity));

          var color = d3.scaleLinear()
              .domain([
                  minScore,
                  (minScore + maxScore) / 4,
                  (minScore + maxScore) / 2,
                  ((minScore + maxScore) * 3) / 4,
                  maxScore,
              ])
              .range(["lime", "yellow", "red", "deepskyblue"]);

          var highlightColor = "blue";
          var highlightTrans = 0.1;

          const citedBy = graph.nodes
              .map(n => n.cited_by)
              .filter(n => n != null);

          const maxCitedBy = Math.max(...citedBy);
          const minCitedBy = Math.min(...citedBy);

          var size = d3.scalePow()
              .exponent(1)
              .domain([minCitedBy, maxCitedBy])
              .range([8, 24]);

          var force = d3.forceSimulation(graph.nodes)
              .force("link", d3.forceLink(graph.links).distance(h / (graph.nodes.length / 10)))
              .force("charge", d3.forceManyBody().strength(-300))
              .force("center", d3.forceCenter(w / 2, h / 2));

          var defaultNodeColor = "#ccc";
          var defaultLinkColor = "#888";
          var nominalBaseNodeSize = 8;
          var nominalTextSize = 10;
          var maxTextSize = 24;
          var nominalStroke = 1.5;
          var maxStroke = 4.5;
          var maxBaseNodeSize = 36;

          var svg = d3.select("body").append("svg")
              .attr("width", w)
              .attr("height", h);

          var g = svg.append("g");

          var link = g.selectAll(".link")
              .data(graph.links)
              .enter().append("line")
              .attr("stroke", defaultLinkColor)
              .attr("stroke-width", nominalStroke);

          var node = g.selectAll(".node")
              .data(graph.nodes)
              .enter().append("g")
              .attr("class", "node")
              .call(d3.drag()
                  .on("start", dragStarted)
                  .on("drag", dragged)
                  .on("end", dragEnded));

          node.on("dblclick", function(d) {
              window.open(d.url, "_blank");
              d3.event.stopPropagation();
          });

          node.append("circle")
              .attr("r", d => size(d.cited_by) || nominalBaseNodeSize)
              .attr("fill", d => isNumber(d.modularity) && d.modularity >= 0 ? color(d.modularity) : defaultNodeColor)
              .attr("stroke", "white")
              .attr("stroke-width", nominalStroke);

          var text = g.selectAll(".text")
              .data(graph.nodes)
              .enter().append("text")
              .attr("dy", ".35em")
              .style("font-size", nominalTextSize + "px")
              .attr("dx", d => size(d.cited_by))
              .text(d => d.title);

          force.on("tick", function () {
              link
                  .attr("x1", d => d.source.x)
                  .attr("y1", d => d.source.y)
                  .attr("x2", d => d.target.x)
                  .attr("y2", d => d.target.y);

              node
                  .attr("transform", d => `translate(${d.x},${d.y})`);

              text
                  .attr("transform", d => `translate(${d.x},${d.y})`);
          });

          function dragStarted(d) {
              if (!d3.event.active) force.alphaTarget(0.3).restart();
              d.fx = d.x;
              d.fy = d.y;
          }

          function dragged(d) {
              d.fx = d3.event.x;
              d.fy = d3.event.y;
          }

          function dragEnded(d) {
              if (!d3.event.active) force.alphaTarget(0);
              d.fx = null;
              d.fy = null;
          }

          function isNumber(n) {
              return !isNaN(parseFloat(n)) && isFinite(n);
          }
      }
  </script>  
  </body>
</html>
